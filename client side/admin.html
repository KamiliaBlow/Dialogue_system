<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора - Терминал GMS-4521</title>
    <link href="https://fonts.googleapis.com/css?family=Orbitron:700" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @font-face {
            font-family: 'TeletactileRus';
            src: url('TeletactileRus.ttf') format('opentype');
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: 'Orbitron', sans-serif;
            color: #03FB8D;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #03FB8D;
            margin-bottom: 30px;
        }

        .admin-title {
            font-size: 24px;
            font-weight: bold;
        }

        .admin-logout {
            background-color: #000;
            border: 1px solid #03FB8D;
            color: #03FB8D;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-logout:hover {
            background-color: #03FB8D;
            color: #000;
        }

        .admin-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #03FB8D;
        }

        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: transparent;
            border: none;
            color: #03FB8D;
            font-family: 'Orbitron', sans-serif;
            position: relative;
            margin-right: 5px;
        }

        .admin-tab:hover {
            background-color: rgba(3, 251, 141, 0.1);
        }

        .admin-tab.active {
            color: #000;
            background-color: #03FB8D;
        }

        .admin-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #03FB8D;
        }

        .admin-content {
            padding: 20px 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .admin-card {
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #03FB8D;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(3, 251, 141, 0.2);
        }

        .admin-card-title {
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(3, 251, 141, 0.3);
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .user-table th,
        .user-table td {
            border: 1px solid rgba(3, 251, 141, 0.3);
            padding: 10px;
            text-align: left;
        }

        .user-table th {
            background-color: rgba(3, 251, 141, 0.1);
        }

        .user-table tr:hover {
            background-color: rgba(3, 251, 141, 0.05);
        }

        .btn {
            background-color: #000;
            border: 1px solid #03FB8D;
            color: #03FB8D;
            padding: 6px 12px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
            margin-right: 5px;
        }

        .btn:hover {
            background-color: #03FB8D;
            color: #000;
        }

        .btn-danger {
            border-color: #ff3333;
            color: #ff3333;
        }

        .btn-danger:hover {
            background-color: #ff3333;
            color: #000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #000;
            border: 1px solid #03FB8D;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(3, 251, 141, 0.3);
        }

        .modal-title {
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(3, 251, 141, 0.3);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #03FB8D;
            color: #03FB8D;
            padding: 8px;
            font-family: 'TeletactileRus', monospace;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .statistic-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background-color: rgba(3, 251, 141, 0.1);
            border-left: 3px solid #03FB8D;
        }

        .statistic-value {
            font-size: 24px;
            font-weight: bold;
        }

        .statistic-label {
            font-size: 14px;
            opacity: 0.8;
        }

        .statistic-icon {
            font-size: 30px;
            opacity: 0.5;
        }

        .choice-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .choice-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: rgba(3, 251, 141, 0.05);
            border-left: 3px solid rgba(3, 251, 141, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .choice-item:hover {
            background-color: rgba(3, 251, 141, 0.1);
            border-left-color: #03FB8D;
        }

        .choice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .choice-title {
            font-weight: bold;
        }

        .choice-count {
            background-color: rgba(3, 251, 141, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .choice-options {
            padding-left: 10px;
            margin-top: 10px;
            display: none;
        }

        .choice-option {
            padding: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .choice-option-text {
            flex: 1;
        }

        .choice-option-count {
            margin-left: 10px;
        }

        .choice-option-percent {
            width: 70px;
            text-align: right;
        }

        .progress-bar {
            height: 5px;
            margin-top: 5px;
            background-color: rgba(3, 251, 141, 0.1);
        }

        .progress-value {
            height: 100%;
            background-color: #03FB8D;
        }

        .expanded .choice-options {
            display: block;
        }

        @media (max-width: 768px) {
            .admin-tabs {
                flex-direction: column;
            }

            .admin-tab {
                width: 100%;
                margin-bottom: 5px;
                margin-right: 0;
            }

            .admin-header {
                flex-direction: column;
                text-align: center;
            }

            .admin-logout {
                margin-top: 10px;
            }

            .statistic-card {
                flex-direction: column;
                text-align: center;
            }

            .statistic-value {
                margin-bottom: 5px;
            }

            .user-table {
                font-size: 12px;
            }

            .btn {
                padding: 4px 8px;
                font-size: 12px;
            }
        }

        /* Анимация для фона, как на странице входа */
        .background-code {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.15;
            z-index: -1;
            overflow: hidden;
            font-family: monospace;
            color: #03FB8D;
            font-size: 14px;
        }

        .code-line {
            position: absolute;
            animation: fallDown 10s linear infinite;
        }

        @keyframes fallDown {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100vh);
            }
        }

        /* Стили для ползунка ввода */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: rgba(3, 251, 141, 0.1);
            outline: none;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #03FB8D;
            cursor: pointer;
        }

        /* Стиль для сообщений */
        .alert {
            padding: 10px 15px;
            margin-bottom: 15px;
            border: 1px solid transparent;
        }

        .alert-success {
            background-color: rgba(0, 128, 0, 0.1);
            border-color: rgba(0, 128, 0, 0.3);
            color: #00ff00;
        }

        .alert-danger {
            background-color: rgba(255, 0, 0, 0.1);
            border-color: rgba(255, 0, 0, 0.3);
            color: #ff3333;
        }

        /* Стили для вкладок детальной статистики */
        .sub-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(3, 251, 141, 0.3);
        }

        .sub-tab {
            padding: 5px 15px;
            cursor: pointer;
            background-color: transparent;
            color: #03FB8D;
            border: none;
            font-family: 'Orbitron', sans-serif;
        }

        .sub-tab.active {
            background-color: rgba(3, 251, 141, 0.1);
            border-bottom: 2px solid #03FB8D;
        }

        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(3, 251, 141, 0.1);
            border-top: 4px solid #03FB8D;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Пагинация */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination-button {
            background-color: transparent;
            border: 1px solid #03FB8D;
            color: #03FB8D;
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination-button:hover {
            background-color: rgba(3, 251, 141, 0.1);
        }

        .pagination-button.active {
            background-color: #03FB8D;
            color: #000;
        }

        .pagination-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Стили для поиска */
        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #03FB8D;
            color: #03FB8D;
            padding: 8px;
            font-family: 'TeletactileRus', monospace;
        }
    </style>
</head>

<body>
    <div class="background-code" id="bgCode"></div>
    <div class="container">
        <div class="admin-header">
            <div class="admin-title">
                ТЕРМИНАЛ GMS-4521 - ПАНЕЛЬ АДМИНИСТРАТОРА
            </div>
            <button id="logout-btn" class="admin-logout">ВЫХОД</button>
        </div>
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="statistics">Статистика</button> <button class="admin-tab" data-tab="users">Пользователи</button> <button class="admin-tab" data-tab="choices">Выборы</button> <button class="admin-tab" data-tab="progress">Прогресс диалогов</button>
        </div>
        <div class="admin-content">
            <div id="statistics" class="tab-content active">
                <div class="admin-card">
                    <div class="admin-card-title">
                        Общая статистика
                    </div>
                    <div id="statistics-loading" class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                    <div id="statistics-content" style="display: none;">
                        <div class="row">
                            <div class="col">
                                <div class="statistic-card">
                                    <div>
                                        <div class="statistic-value" id="total-users">
                                            0
                                        </div>
                                        <div class="statistic-label">
                                            Всего пользователей
                                        </div>
                                    </div>
                                    <div class="statistic-icon">
                                        👤
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="statistic-card">
                                    <div>
                                        <div class="statistic-value" id="total-choices">
                                            0
                                        </div>
                                        <div class="statistic-label">
                                            Всего выборов
                                        </div>
                                    </div>
                                    <div class="statistic-icon">
                                        🔄
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="statistic-card">
                                    <div>
                                        <div class="statistic-value" id="completed-dialogues">
                                            0
                                        </div>
                                        <div class="statistic-label">
                                            Завершенных диалогов
                                        </div>
                                    </div>
                                    <div class="statistic-icon">
                                        ✅
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="admin-card-title">
                        Распределение выборов по частотам
                    </div>
                    <div class="chart-container">
                        <canvas id="frequency-chart"></canvas>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="admin-card-title">
                        Популярные выборы
                    </div>
                    <div class="chart-container">
                        <canvas id="choices-chart"></canvas>
                    </div>
                </div>
            </div>
            <div id="users" class="tab-content">
                <div class="admin-card">
                    <div class="admin-card-title">
                        Управление пользователями
                    </div>
                    <div class="search-container">
                        <input type="text" id="user-search" class="search-input" placeholder="Поиск пользователя...">
                    </div>
                    <div id="users-loading" class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                    <table class="user-table" id="users-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Позывной</th>
                                <th>Дата регистрации</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                    <div class="pagination" id="users-pagination"></div>
                </div>
            </div>
            <div id="choices" class="tab-content">
                <div class="admin-card">
                    <div class="admin-card-title">
                        Выборы пользователей
                    </div>
                    <div class="sub-tabs">
                    </div>
                    <div id="choices-loading" class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                    <div id="choices-content" style="display: none;">
                        <ul class="choice-list" id="choice-list"></ul>
                    </div>
                </div>
            </div>
            <div id="progress" class="tab-content">
                <div class="admin-card">
                    <div class="admin-card-title">
                        Прогресс пользователей в диалогах
                    </div>
                    <div id="progress-loading" class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                    <div id="progress-content" style="display: none;">
                        <div class="chart-container">
                            <canvas id="progress-chart"></canvas>
                        </div>
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>Пользователь</th>
                                    <th>Частота</th>
                                    <th>Прогресс</th>
                                    <th>Завершен</th>
                                </tr>
                            </thead>
                            <tbody id="progress-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">
                Изменить пароль
            </div>
            <div class="modal-body">
                <form id="change-password-form" name="change-password-form">
                    <input type="hidden" id="user-id-input">
                    <div class="form-group">
                        <label class="form-label">Пользователь:</label>
                        <div id="modal-username"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="new-password">Новый пароль:</label> <input type="password" id="new-password" class="form-input" required="" minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="confirm-password">Подтвердите пароль:</label> <input type="password" id="confirm-password" class="form-input" required="" minlength="6">
                    </div>
                    <div id="password-error" class="alert alert-danger" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-actions">
                <button id="cancel-password" class="btn">Отмена</button> <button id="save-password" class="btn">Сохранить</button>
            </div>
        </div>
    </div>
    <div id="choice-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">
                Детализация выбора
            </div>
            <div class="modal-body">
                <div id="choice-details-loading" class="loading">
                    <div class="loading-spinner"></div>
                </div>
                <div id="choice-details-content" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Частота:</label>
                        <div id="detail-frequency"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ID выбора:</label>
                        <div id="detail-choice-id"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Варианты ответов:</label>
                        <div id="detail-options"></div>
                    </div>
                    <div class="chart-container">
                        <canvas id="detail-chart"></canvas>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Список пользователей:</label>
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>Пользователь</th>
                                    <th>Вариант</th>
                                    <th>Дата выбора</th>
                                </tr>
                            </thead>
                            <tbody id="detail-users-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="close-details" class="btn">Закрыть</button>
            </div>
        </div>
    </div>
    <script>
        // Константы const 
        API_URL = 'https://yousite:3000/api';
        const ITEMS_PER_PAGE = 10;

        // Состояние приложения
        const state = {
            users: [],
            currentUserPage: 1,
            totalUserPages: 1,
            choiceStats: [],
            currentFrequency: 'all',
            progressData: [],
            charts: {},
            frequencies: [] // Новое свойство для хранения загруженных частот
        };

        // Обработчики DOM при загрузке страницы
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Проверка авторизации и прав администратора
                const authResponse = await fetch(`${API_URL}/admin/check`, {
                    credentials: 'include',
                    // Добавим параметры для предотвращения кеширования
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0',
                    }
                });

                if (!authResponse.ok) {
                    // Если запрос завершился с ошибкой, перенаправляем на страницу входа
                    console.error('Ошибка при проверке авторизации:', authResponse.status);
                    window.location.href = 'index.html';
                    return;
                }

                const authData = await authResponse.json();

                if (!authData.isAdmin) {
                    console.error('Доступ запрещен: пользователь не является администратором');
                    // Добавляем небольшую задержку перед перенаправлением
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 100);
                    return;
                }

                console.log('Административный доступ подтвержден');

                // Инициализация вкладок
                initializeTabs();

                // Загрузка данных для первой активной вкладки (статистика)
                loadStatisticsData();

                // Обработчик клика для кнопки выхода
                document.getElementById('logout-btn').addEventListener('click', logout);

                // Обработчики модальных окон
                initializeModals();

                // Генерация фонового кода
                generateBackgroundCode();
            } catch (error) {
                console.error('Ошибка при инициализации панели администратора:', error);
                alert('Произошла ошибка при загрузке панели администратора. Перенаправление на главную страницу...');
                window.location.href = 'index.html';
            }
        });

        // Инициализация вкладок
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.admin-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.getAttribute('data-tab');

                    // Сначала удаляем активный класс у всех вкладок
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Добавляем активный класс нужной вкладке
                    button.classList.add('active');
                    document.getElementById(tabName).classList.add('active');

                    // Загружаем данные для активной вкладки
                    switch (tabName) {
                        case 'statistics':
                            loadStatisticsData();
                            break;
                        case 'users':
                            loadUsersData();
                            break;
                        case 'choices':
                            // Если перешли на вкладку выборов, загружаем частоты и обновляем подвкладки
                            updateFrequencyTabs().then(() => loadChoicesData());
                            break;
                        case 'progress':
                            loadProgressData();
                            break;
                    }
                });
            });
        }

        // Инициализация модальных окон
        function initializeModals() {
            // Модальное окно смены пароля
            const passwordModal = document.getElementById('password-modal');

            document.getElementById('cancel-password').addEventListener('click', () => {
                passwordModal.style.display = 'none';
            });

            document.getElementById('save-password').addEventListener('click', changeUserPassword);

            // Модальное окно детализации выбора
            const choiceDetailsModal = document.getElementById('choice-details-modal');

            document.getElementById('close-details').addEventListener('click', () => {
                choiceDetailsModal.style.display = 'none';
            });

            // Закрытие модальных окон при клике вне содержимого
            window.addEventListener('click', (event) => {
                if (event.target === passwordModal) {
                    passwordModal.style.display = 'none';
                }
                if (event.target === choiceDetailsModal) {
                    choiceDetailsModal.style.display = 'none';
                }
            });
        }

        // Загрузка данных статистики
        async function loadStatisticsData() {
            showLoading('statistics');

            try {
                // Массив для хранения результатов запросов
                const results = {
                    users: null,
                    choices: null,
                    progress: null
                };

                // Загрузка данных о пользователях
                try {
                    results.users = await safeFetch(`${API_URL}/admin/users`);
                    if (results.users && results.users.users && Array.isArray(results.users.users)) {
                        // Обновление счетчика пользователей
                        document.getElementById('total-users').textContent = results.users.users.length;
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке данных о пользователях:', error);
                }

                // Загрузка данных о выборах
                try {
                    results.choices = await safeFetch(`${API_URL}/admin/choice-statistics`);
                    if (results.choices && results.choices.statistics && Array.isArray(results.choices.statistics)) {
                        // Обновление счетчика выборов
                        document.getElementById('total-choices').textContent = results.choices.statistics.length;

                        // Создание графиков
                        if (results.choices.statistics.length > 0) {
                            createFrequencyChart(results.choices.statistics);
                            createChoicesChart(results.choices.statistics);
                        }
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке данных о выборах:', error);
                    document.getElementById('frequency-chart').innerHTML = '<div class="no-data">Нет данных для отображения';
                    document.getElementById('choices-chart').innerHTML = '<div class="no-data">Нет данных для отображения';
                }

                // Загрузка данных о прогрессе
                try {
                    results.progress = await safeFetch(`${API_URL}/admin/user-progress`);
                    if (results.progress && results.progress.progress && Array.isArray(results.progress.progress)) {
                        // Обновление счетчика завершенных диалогов
                        const completedDialogues = results.progress.progress.filter(p => p.completed).length;
                        document.getElementById('completed-dialogues').textContent = completedDialogues;
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке данных о прогрессе:', error);
                }

                // Проверка, получены ли какие-либо данные
                if (!results.users && !results.choices && !results.progress) {
                    throw new Error('Не удалось загрузить никакие данные статистики');
                }

                // Отображение содержимого
                hideLoading('statistics');

                // Если были ошибки, но некоторые данные получены, показываем предупреждение
                if (!results.users || !results.choices || !results.progress) {
                    const warning = document.createElement('div');
                    warning.className = 'alert alert-warning';
                    warning.textContent = 'Некоторые данные статистики недоступны. Панель управления работает в ограниченном режиме.';

                    const contentElement = document.getElementById('statistics-content');
                    if (contentElement) {
                        contentElement.insertBefore(warning, contentElement.firstChild);

                        // Автоматически скрываем сообщение через 10 секунд
                        setTimeout(() => {
                            warning.style.display = 'none';
                        }, 10000);
                    }
                }
            } catch (error) {
                console.error('Ошибка при загрузке статистики:', error);
                hideLoading('statistics');

                const errorMsg = typeof error === 'string' ? error :
                    error.message ? error.message :
                    'Неизвестная ошибка';

                showErrorMessage('statistics-content', `Не удалось загрузить статистику: ${errorMsg}`);

                // Отображаем пустые графики
                document.getElementById('frequency-chart').innerHTML = '<div class="no-data">Нет данных для отображения';
                document.getElementById('choices-chart').innerHTML = '<div class="no-data">Нет данных для отображения';
            }
        }

        // Создание графика по частотам
        function createFrequencyChart(statistics) {
            const frequencyData = {};

            // Группировка по частотам
            statistics.forEach(stat => {
                if (!frequencyData[stat.frequency]) {
                    frequencyData[stat.frequency] = 0;
                }
                frequencyData[stat.frequency] += parseInt(stat.count);
            });

            // Проверяем, есть ли данные
            if (Object.keys(frequencyData).length === 0) {
                console.warn('Нет данных для отображения графика частот');
                document.getElementById('frequency-chart').innerHTML = '<div class="no-data">Нет данных для отображения';
                return;
            }

            // Преобразование данных для графика
            const labels = Object.keys(frequencyData);
            const data = Object.values(frequencyData);

            // Создание графика
            const ctx = document.getElementById('frequency-chart').getContext('2d');

            if (state.charts.frequencyChart) {
                state.charts.frequencyChart.destroy();
            }

            // Генерируем больше цветов для возможных дополнительных частот
            const colors = generateColorsForFrequencies(labels.length);

            state.charts.frequencyChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.backgroundColors,
                        borderColor: colors.borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#03FB8D'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Распределение выборов по частотам',
                            color: '#03FB8D'
                        }
                    }
                }
            });
        }

        /**
         * Генерация цветов для графика частот
         * @param {number} count - Количество требуемых цветов
         * @returns {Object} Объект с массивами цветов для фона и границ
         */
        function generateColorsForFrequencies(count) {
            const backgroundColors = [];
            const borderColors = [];

            // Базовые цвета для первых трех частот
            const baseColors = [
                'rgba(3, 251, 141, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)'
            ];

            const baseBorderColors = [
                'rgba(3, 251, 141, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
            ];

            // Добавляем базовые цвета
            for (let i = 0; i < Math.min(count, baseColors.length); i++) {
                backgroundColors.push(baseColors[i]);
                borderColors.push(baseBorderColors[i]);
            }

            // Если нужно больше цветов, генерируем их
            if (count > baseColors.length) {
                for (let i = baseColors.length; i < count; i++) {
                    // Используем золотое сечение для создания разных оттенков
                    const hue = (i * 137.5) % 360;
                    backgroundColors.push(`hsla(${hue}, 70%, 60%, 0.7)`);
                    borderColors.push(`hsla(${hue}, 70%, 60%, 1)`);
                }
            }

            return {
                backgroundColors,
                borderColors
            };
        }

        // Создание графика по популярным выборам
        function createChoicesChart(statistics) {
            // Группировка выборов по choiceId
            const choiceGroups = {};
            statistics.forEach(stat => {
                const key = `${stat.frequency}-${stat.choice_id}`;
                if (!choiceGroups[key]) {
                    choiceGroups[key] = {
                        label: `${stat.frequency}: ${stat.choice_id}`,
                        total: 0,
                        options: {}
                    };
                }

                choiceGroups[key].total += parseInt(stat.count);
                choiceGroups[key].options[stat.option_id] = {
                    text: stat.choice_text,
                    count: parseInt(stat.count)
                };
            });

            // Преобразуем в массив и сортируем по общему количеству
            const sortedChoices = Object.values(choiceGroups).sort((a, b) => b.total - a.total);

            // Берем только топ-5 самых популярных выборов
            const topChoices = sortedChoices.slice(0, 5);

            // Подготовка данных для графика
            const datasets = [];
            const colors = [
                'rgba(3, 251, 141, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(255, 99, 132, 0.7)'
            ];

            topChoices.forEach((choice, index) => {
                const data = [];
                const labels = [];

                // Формируем данные для каждой опции
                Object.entries(choice.options).forEach(([optionId, option]) => {
                    labels.push(optionId);
                    data.push(option.count);
                });

                datasets.push({
                    label: choice.label,
                    data: data,
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length].replace('0.7', '1'),
                    borderWidth: 1
                });
            });

            // Создание графика
            const ctx = document.getElementById('choices-chart').getContext('2d');

            if (state.charts.choicesChart) {
                state.charts.choicesChart.destroy();
            }

            state.charts.choicesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topChoices.map(choice => choice.label),
                    datasets: [{
                        label: 'Количество выборов',
                        data: topChoices.map(choice => choice.total),
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Топ-5 популярных выборов',
                            color: '#03FB8D'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#03FB8D'
                            },
                            grid: {
                                color: 'rgba(3, 251, 141, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#03FB8D'
                            },
                            grid: {
                                color: 'rgba(3, 251, 141, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Загрузка данных пользователей 
        async function loadUsersData() {
            // Проверяем, существует ли элемент перед показом загрузки 
            const loadingElement = document.getElementById('users-loading');
            const tableBody = document.getElementById('users-table-body');
            const usersTable = document.getElementById('users-table');

            if (loadingElement) {
                loadingElement.style.display = 'flex';
            }

            if (usersTable) {
                usersTable.style.display = 'none';
            }

            try {
                const data = await safeFetch(`${API_URL}/admin/users`);

                if (!data || !data.users || !Array.isArray(data.users)) {
                    throw new Error('Получены некорректные данные о пользователях');
                }

                state.users = data.users;
                state.totalUserPages = Math.ceil(state.users.length / ITEMS_PER_PAGE) || 1;

                renderUsersTable();
                renderUsersPagination();

                // Инициализация поиска
                const searchInput = document.getElementById('user-search');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();

                        if (searchTerm) {
                            const filteredUsers = state.users.filter(user =>
                                user.username.toLowerCase().includes(searchTerm)
                            );
                            renderUsersTable(filteredUsers);
                        } else {
                            renderUsersTable();
                        }
                    });
                }

                // Скрываем индикатор загрузки и показываем таблицу
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }

                if (usersTable) {
                    usersTable.style.display = 'table';
                }
            } catch (error) {
                console.error('Ошибка при загрузке пользователей:', error);

                // Устанавливаем пустой массив пользователей
                state.users = [];
                state.totalUserPages = 1;

                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }

                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Нет данных о пользователях. Возможно, сервер временно недоступен.';
                }

                if (usersTable) {
                    usersTable.style.display = 'table';
                }

                showErrorMessage('users', `Не удалось загрузить список пользователей: ${error.message}`);
            }
        }

        // Отрисовка таблицы пользователей с учетом пагинации
        function renderUsersTable(users = null) {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';

            const usersToRender = users || state.users;

            // Вычисляем начальный и конечный индексы для текущей страницы
            const startIndex = (state.currentUserPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, usersToRender.length);

            // Отображаем только пользователей текущей страницы
            const pageUsers = usersToRender.slice(startIndex, endIndex);

            if (pageUsers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" style="text-align: center;">Пользователи не найдены';
                tableBody.appendChild(row);
            } else {
                pageUsers.forEach(user => {
                    const row = document.createElement('tr');

                    // Форматируем дату
                    const createdAt = new Date(user.created_at);
                    const formattedDate = `${createdAt.toLocaleDateString()} ${createdAt.toLocaleTimeString()}`;

                    row.innerHTML = `
         <td>${user.id}
         <td>${user.username}
         <td>${formattedDate}
         <td>
           <button class="btn change-password-btn" data-id="${user.id}" data-username="${user.username}">
             Сменить пароль
           
         
         `;

                    tableBody.appendChild(row);

                });

                // Добавляем обработчики для кнопок смены пароля
                document.querySelectorAll('.change-password-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        openPasswordModal(this.getAttribute('data-id'), this.getAttribute('data-username'));
                    });
                });
            }

            // Показываем таблицу
            document.getElementById('users-table').style.display = 'table';
        }

        // Отрисовка пагинации для таблицы пользователей
        function renderUsersPagination() {
            const paginationContainer = document.getElementById('users-pagination');
            paginationContainer.innerHTML = '';

            if (state.totalUserPages <= 1) {
                return;
            }

            // Кнопка "Предыдущая"
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '«';
            prevButton.classList.add('pagination-button');
            if (state.currentUserPage === 1) {
                prevButton.classList.add('disabled');
            } else {
                prevButton.addEventListener('click', () => {
                    if (state.currentUserPage > 1) {
                        state.currentUserPage--;
                        renderUsersTable();
                        renderUsersPagination();
                    }
                });
            }
            paginationContainer.appendChild(prevButton);

            // Кнопки с номерами страниц
            const maxVisiblePages = 5;
            let startPage = Math.max(1, state.currentUserPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(state.totalUserPages, startPage + maxVisiblePages - 1);

            // Корректируем startPage, если endPage стал меньше из-за максимального значения
            startPage = Math.max(1, endPage - maxVisiblePages + 1);

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.add('pagination-button');

                if (i === state.currentUserPage) {
                    pageButton.classList.add('active');
                } else {
                    pageButton.addEventListener('click', () => {
                        state.currentUserPage = i;
                        renderUsersTable();
                        renderUsersPagination();
                    });
                }

                paginationContainer.appendChild(pageButton);
            }

            // Кнопка "Следующая"
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '»';
            nextButton.classList.add('pagination-button');

            if (state.currentUserPage === state.totalUserPages) {
                nextButton.classList.add('disabled');
            } else {
                nextButton.addEventListener('click', () => {
                    if (state.currentUserPage < state.totalUserPages) {
                        state.currentUserPage++;
                        renderUsersTable();
                        renderUsersPagination();
                    }
                });
            }
            paginationContainer.appendChild(nextButton);
        }

        // Открытие модального окна для смены пароля
        function openPasswordModal(userId, username) {
            document.getElementById('user-id-input').value = userId;
            document.getElementById('modal-username').textContent = username;
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('password-error').style.display = 'none';

            document.getElementById('password-modal').style.display = 'flex';
        }

        // Изменение пароля пользователя
        async function changeUserPassword() {
            const userId = document.getElementById('user-id-input').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorElement = document.getElementById('password-error');

            // Проверка валидности пароля
            if (newPassword.length < 6) {
                errorElement.textContent = 'Пароль должен содержать минимум 6 символов';
                errorElement.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorElement.textContent = 'Пароли не совпадают';
                errorElement.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/admin/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        newPassword: newPassword
                    }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Ошибка при изменении пароля');
                }

                // Закрываем модальное окно
                document.getElementById('password-modal').style.display = 'none';

                // Показываем уведомление об успешном изменении
                showSuccessMessage('users-table', 'Пароль успешно изменен');
            } catch (error) {
                console.error('Ошибка при изменении пароля:', error);
                errorElement.textContent = error.message || 'Произошла ошибка. Попробуйте позже.';
                errorElement.style.display = 'block';
            }
        }

        // Загрузка данных о выборах пользователей
        // Обновляем функцию загрузки данных о выборах
        async function loadChoicesData() {
            // Проверяем, существует ли элемент перед показом загрузки
            const loadingElement = document.getElementById('choices-loading');
            const contentElement = document.getElementById('choices-content');
            const choiceList = document.getElementById('choice-list');

            if (loadingElement && contentElement) {
                loadingElement.style.display = 'flex';
                contentElement.style.display = 'none';
            }

            try {
                console.log(`Загрузка данных о выборах для частоты: ${state.currentFrequency}`);

                const data = await safeFetch(`${API_URL}/admin/choice-statistics`);

                if (!data || !data.statistics || !Array.isArray(data.statistics)) {
                    throw new Error('Получены некорректные данные о выборах');
                }

                state.choiceStats = data.statistics;
                console.log(`Всего получено записей о выборах: ${state.choiceStats.length}`);

                // Проверяем, если для выбранной частоты нет данных
                const filteredStats = state.currentFrequency === 'all' ?
                    state.choiceStats :
                    state.choiceStats.filter(stat => stat.frequency === state.currentFrequency);

                console.log(`Отфильтровано записей для частоты ${state.currentFrequency}: ${filteredStats.length}`);

                renderChoicesList();

                if (loadingElement && contentElement) {
                    loadingElement.style.display = 'none';
                    contentElement.style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка при загрузке статистики выборов:', error);

                // Устанавливаем пустой массив для избежания ошибок в других функциях
                state.choiceStats = [];

                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }

                if (contentElement) {
                    contentElement.style.display = 'block';
                }

                if (choiceList) {
                    choiceList.innerHTML = '<li class="choice-item">Нет данных о выборах. Возможно, сервер временно недоступен.';
                }

                showErrorMessage('choices-content', `Не удалось загрузить статистику выборов: ${error.message}`);
            }
        }

        // Функция для загрузки и парсинга Config.js
        async function loadFrequenciesFromScript() {
            try {
                // Загружаем содержимое Config.js
                const response = await fetch('Config.js');
                if (!response.ok) {
                    throw new Error(`Ошибка загрузки Config.js: ${response.status}`);
                }

                const scriptContent = await response.text();

                // Ищем массив frequencies в скрипте с помощью регулярного выражения
                const frequencyMatch = scriptContent.match(/'frequencies':\s*\[(.*?)\]/s);

                if (!frequencyMatch || !frequencyMatch[1]) {
                    console.error('Не удалось найти массив frequencies в Config.js');
                    return ['145.55', 'PRIV', '???']; // Возвращаем массив по умолчанию в случае ошибки
                }

                // Парсим массив частот
                const frequenciesString = frequencyMatch[1];
                const frequencies = frequenciesString.split(',')
                    .map(item => item.trim().replace(/['"]/g, '')) // Убираем кавычки и пробелы
                    .filter(item => item); // Фильтруем пустые значения

                console.log('Загруженные частоты:', frequencies);
                return frequencies;
            } catch (error) {
                console.error('Ошибка при загрузке частот из Config.js:', error);
                return ['145.55', 'PRIV', '???']; // Возвращаем массив по умолчанию в случае ошибки
            }
        }

        // Функция для обновления вкладок с частотами
        async function updateFrequencyTabs() {
            try {
                // Загружаем частоты
                const frequencies = await loadFrequenciesFromScript();

                // Находим контейнер с вкладками частот
                const subTabsContainer = document.querySelector('.sub-tabs');
                if (!subTabsContainer) {
                    console.error('Контейнер для вкладок частот не найден');
                    return;
                }

                // Очищаем контейнер
                subTabsContainer.innerHTML = '';

                // Добавляем вкладку "Все частоты"
                const allTab = document.createElement('button');
                allTab.className = 'sub-tab active';
                allTab.setAttribute('data-freq', 'all');
                allTab.textContent = 'Все частоты';
                subTabsContainer.appendChild(allTab);

                // Добавляем вкладки для каждой частоты
                frequencies.forEach(frequency => {
                    const tab = document.createElement('button');
                    tab.className = 'sub-tab';
                    tab.setAttribute('data-freq', frequency);
                    tab.textContent = frequency;
                    subTabsContainer.appendChild(tab);
                });

                // Обновляем обработчики событий для вкладок
                initializeSubTabs();

                console.log('Вкладки с частотами успешно обновлены');
            } catch (error) {
                console.error('Ошибка при обновлении вкладок с частотами:', error);
            }
        }

        /**
         * Инициализация обработчиков для вкладок с частотами
         */
        function initializeSubTabs() {
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Сначала удаляем активный класс у всех подвкладок
                    subTabs.forEach(t => t.classList.remove('active'));

                    // Добавляем активный класс нужной подвкладке
                    tab.classList.add('active');

                    // Устанавливаем текущую частоту и перезагружаем данные
                    state.currentFrequency = tab.getAttribute('data-freq');
                    loadChoicesData();
                });
            });
        }

        // Изменяем функцию инициализации страницы, чтобы она вызывала обновление вкладок с частотами
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Проверка авторизации и прав администратора
                const authResponse = await fetch(`${API_URL}/admin/check`, {
                    credentials: 'include',
                    // Добавим параметры для предотвращения кеширования
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0',
                    }
                });

                if (!authResponse.ok) {
                    // Если запрос завершился с ошибкой, перенаправляем на страницу входа
                    console.error('Ошибка при проверке авторизации:', authResponse.status);
                    window.location.href = 'index.html';
                    return;
                }

                const authData = await authResponse.json();

                if (!authData.isAdmin) {
                    console.error('Доступ запрещен: пользователь не является администратором');
                    // Добавляем небольшую задержку перед перенаправлением
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 100);
                    return;
                }

                console.log('Административный доступ подтвержден');

                // Инициализация вкладок
                initializeTabs();

                // Обновляем вкладки с частотами
                await updateFrequencyTabs();

                // Загрузка данных для первой активной вкладки (статистика)
                loadStatisticsData();

                // Обработчик клика для кнопки выхода
                document.getElementById('logout-btn').addEventListener('click', logout);

                // Обработчики модальных окон
                initializeModals();

                // Генерация фонового кода
                generateBackgroundCode();
            } catch (error) {
                console.error('Ошибка при инициализации панели администратора:', error);
                alert('Произошла ошибка при загрузке панели администратора. Перенаправление на главную страницу...');
                window.location.href = 'index.html';
            }
        });

        // Отрисовка списка выборов
        function renderChoicesList() {
            const choiceList = document.getElementById('choice-list');
            if (!choiceList) return;

            choiceList.innerHTML = '';

            // Проверка на наличие данных
            if (!state.choiceStats || state.choiceStats.length === 0) {
                choiceList.innerHTML = '<li class="choice-item">Нет данных о выборах';
                if (document.getElementById('choices-content')) {
                    document.getElementById('choices-content').style.display = 'block';
                }
                return;
            }

            // Группировка выборов по choiceId и frequency
            const choiceGroups = {};

            state.choiceStats.forEach(stat => {
                // Фильтрация по частоте, если выбрана конкретная частота
                if (state.currentFrequency !== 'all' && stat.frequency !== state.currentFrequency) {
                    return;
                }

                const key = `${stat.frequency}-${stat.choice_id}`;

                if (!choiceGroups[key]) {
                    choiceGroups[key] = {
                        frequency: stat.frequency,
                        choiceId: stat.choice_id,
                        total: 0,
                        options: []
                    };
                }

                // Преобразуем count в число и добавляем проверку на NaN
                const count = parseInt(stat.count);
                choiceGroups[key].total += isNaN(count) ? 0 : count;

                choiceGroups[key].options.push({
                    optionId: stat.option_id,
                    text: stat.choice_text || 'Нет текста',
                    count: isNaN(count) ? 0 : count,
                    users: stat.users ? stat.users.split(',') : []
                });
            });

            // Преобразуем в массив и сортируем по frequency и choiceId
            const sortedChoices = Object.values(choiceGroups).sort((a, b) => {
                if (a.frequency !== b.frequency) {
                    return a.frequency.localeCompare(b.frequency);
                }
                return a.choiceId.localeCompare(b.choiceId);
            });

            if (sortedChoices.length === 0) {
                choiceList.innerHTML = '<li class="choice-item">Нет данных о выборах для выбранной частоты';
                if (document.getElementById('choices-content')) {
                    document.getElementById('choices-content').style.display = 'block';
                }
                return;
            }

            // Отображаем выборы
            sortedChoices.forEach(choice => {
                // [Оставшаяся часть функции без изменений]
                // Продолжаем с создания элементов интерфейса для каждого выбора
                const listItem = document.createElement('li');
                listItem.className = 'choice-item';
                listItem.dataset.frequency = choice.frequency;
                listItem.dataset.choiceId = choice.choiceId;

                // Сортируем опции по количеству выборов (по убыванию)
                choice.options.sort((a, b) => b.count - a.count);

                // Заголовок выбора
                const header = document.createElement('div');
                header.className = 'choice-header';
                header.innerHTML = `
         <div class="choice-title">${choice.frequency}: ${choice.choiceId}
         <div class="choice-count">${choice.total} выборов
         `;
                listItem.appendChild(header);

                // Контейнер для опций
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'choice-options';

                // Добавляем каждый вариант
                choice.options.forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'choice-option';

                    // Вычисляем процент (защищаемся от деления на ноль)
                    const percent = choice.total > 0 ? Math.round((option.count / choice.total) * 100) : 0;

                    optionDiv.innerHTML = `
         <div class="choice-option-text">${option.text}
         <div class="choice-option-count">${option.count}
         <div class="choice-option-percent">${percent}%
         `;

                    // Добавляем прогресс-бар
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';

                    const progressValue = document.createElement('div');
                    progressValue.className = 'progress-value';
                    progressValue.style.width = `${percent}%`;

                    progressBar.appendChild(progressValue);
                    optionDiv.appendChild(progressBar);

                    optionsContainer.appendChild(optionDiv);
                });

                listItem.appendChild(optionsContainer);

                // Добавляем обработчик для раскрытия/скрытия опций
                listItem.addEventListener('click', function(event) {
                    // Если клик был не на самом элементе, а на вложенном - игнорируем
                    if (event.target !== this && !this.contains(event.target)) {
                        return;
                    }

                    this.classList.toggle('expanded');
                });

                // Добавляем кнопку для просмотра детализации
                const detailButton = document.createElement('button');
                detailButton.className = 'btn';
                detailButton.textContent = 'Детализация';
                detailButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Предотвращаем раскрытие/скрытие при клике на кнопку
                    openChoiceDetailsModal(choice.frequency, choice.choiceId);
                });

                listItem.appendChild(detailButton);

                choiceList.appendChild(listItem);
            });

            if (document.getElementById('choices-content')) {
                document.getElementById('choices-content').style.display = 'block';
            }
        }

        // Открытие модального окна с детализацией выбора
        async function openChoiceDetailsModal(frequency, choiceId) {
            const modal = document.getElementById('choice-details-modal');
            if (!modal) return;

            modal.style.display = 'flex';

            const frequencyElement = document.getElementById('detail-frequency');
            const choiceIdElement = document.getElementById('detail-choice-id');

            if (frequencyElement) frequencyElement.textContent = frequency;
            if (choiceIdElement) choiceIdElement.textContent = choiceId;

            const loadingElement = document.getElementById('choice-details-loading');
            const contentElement = document.getElementById('choice-details-content');

            if (loadingElement) loadingElement.style.display = 'flex';
            if (contentElement) contentElement.style.display = 'none';

            try {
                // Создадим переменную для хранения данных
                let data = {
                    details: []
                };

                // Пытаемся получить данные с сервера 
                try {
                    const response = await fetch(`${API_URL}/admin/choice-details/${frequency}/${choiceId}`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        data = await response.json();
                    } else {
                        console.warn(`Сервер вернул ошибку: ${response.status} ${response.statusText}`);
                        // Не выбрасываем исключение, просто отображаем сообщение об ошибке
                        throw new Error(`Ошибка сервера: ${response.status} ${response.statusText}`);
                    }
                } catch (fetchError) {
                    throw fetchError; // Пробрасываем исключение дальше
                }

                // Проверяем данные на корректность
                if (!data || !data.details || !Array.isArray(data.details)) {
                    throw new Error('Получены некорректные данные о деталях выбора');
                }

                renderChoiceDetails(data.details, frequency, choiceId);
            } catch (error) {
                console.error('Ошибка при загрузке деталей выбора:', error);

                const detailOptions = document.getElementById('detail-options');
                if (detailOptions) {
                    detailOptions.textContent = `Ошибка при загрузке деталей: ${error.message}`;
                }

                if (loadingElement) loadingElement.style.display = 'none';
                if (contentElement) contentElement.style.display = 'block';
            }
        }

        // Отрисовка деталей выбора в модальном окне
        function renderChoiceDetails(details, frequency, choiceId) {
            const optionsContainer = document.getElementById('detail-options');
            const usersTable = document.getElementById('detail-users-table');

            optionsContainer.innerHTML = '';
            usersTable.innerHTML = '';

            // Группируем детали по вариантам
            const optionGroups = {};
            details.forEach(detail => {
                if (!optionGroups[detail.option_id]) {
                    optionGroups[detail.option_id] = {
                        optionId: detail.option_id,
                        text: detail.choice_text,
                        users: [],
                        count: 0
                    };
                }

                optionGroups[detail.option_id].users.push({
                    username: detail.username,
                    createdAt: detail.created_at
                });
                optionGroups[detail.option_id].count++;
            });

            // Преобразуем в массив и сортируем по количеству
            const sortedOptions = Object.values(optionGroups).sort((a, b) => b.count - a.count);

            // Отображаем варианты
            sortedOptions.forEach(option => {
                const optionText = document.createElement('div');
                optionText.innerHTML = `<strong>${option.text} (${option.count} выборов)`;
                optionsContainer.appendChild(optionText);
            });

            // Создаем круговую диаграмму
            createDetailChart(sortedOptions);

            // Заполняем таблицу пользователей
            details.forEach(detail => {
                const row = document.createElement('tr');

                // Форматируем дату
                const createdAt = new Date(detail.created_at);
                const formattedDate = `${createdAt.toLocaleDateString()} ${createdAt.toLocaleTimeString()}`;

                row.innerHTML = `
         <td>${detail.username}
         <td>${detail.choice_text}
         <td>${formattedDate}
         `;

                usersTable.appendChild(row);
            });

            document.getElementById('choice-details-loading').style.display = 'none';
            document.getElementById('choice-details-content').style.display = 'block';
        }

        // Создает круговую диаграмму для деталей выбора
        function createDetailChart(options) {
            const ctx = document.getElementById('detail-chart').getContext('2d');

            if (state.charts.detailChart) {
                state.charts.detailChart.destroy();
            }

            const labels = options.map(option => `${option.text}`);
            const data = options.map(option => option.count);
            const colors = options.map((_, index) => {
                const hue = (index * 137.5) % 360; // Используем золотое сечение для генерации цветов
                return `hsla(${hue}, 80%, 60%, 0.7)`;
            });

            state.charts.detailChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#03FB8D',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Распределение ответов',
                            color: '#03FB8D'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const percent = Math.round((value / context.dataset.data.reduce((a, b) => a + b, 0)) * 100);
                                    return `${label}: ${value} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Загрузка данных о прогрессе пользователей 
        async function loadProgressData() {
            const loadingElement = document.getElementById('progress-loading');
            const contentElement = document.getElementById('progress-content');
            const tableBody = document.getElementById('progress-table-body');

            if (loadingElement && contentElement) {
                loadingElement.style.display = 'flex';
                contentElement.style.display = 'none';
            }

            try {
                console.log('Загрузка данных о прогрессе пользователей...');

                const data = await safeFetch(`${API_URL}/admin/user-progress`);

                if (!data || !data.progress || !Array.isArray(data.progress)) {
                    throw new Error('Получены некорректные данные о прогрессе');
                }

                console.log(`Всего получено записей о прогрессе: ${data.progress.length}`);
                state.progressData = data.progress;

                renderProgressData();

                if (loadingElement && contentElement) {
                    loadingElement.style.display = 'none';
                    contentElement.style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка при загрузке данных о прогрессе:', error);

                // Устанавливаем пустой массив прогресса
                state.progressData = [];

                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }

                if (contentElement) {
                    contentElement.style.display = 'block';
                }

                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Нет данных о прогрессе. Возможно, сервер временно недоступен.';
                }

                // Очищаем график
                const chartCanvas = document.getElementById('progress-chart');
                if (chartCanvas) {
                    if (state.charts.progressChart) {
                        state.charts.progressChart.destroy();
                        state.charts.progressChart = null;
                    }
                    const ctx = chartCanvas.getContext('2d');
                    if (ctx) {
                        ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                    }
                    chartCanvas.innerHTML = '<div class="no-data">Нет данных для отображения';
                }

                showErrorMessage('progress-content', `Не удалось загрузить данные о прогрессе: ${error.message}`);
            }
        }

        // Создание диаграммы прогресса пользователей
        function createProgressChart() {
            // Проверяем наличие данных и canvas элемента
            if (!state.progressData || state.progressData.length === 0) {
                console.log('Нет данных для создания графика прогресса');
                const chartCanvas = document.getElementById('progress-chart');
                if (chartCanvas) {
                    chartCanvas.innerHTML = '<div class="no-data">Нет данных для отображения';
                }
                return;
            }

            const chartCanvas = document.getElementById('progress-chart');
            if (!chartCanvas) {
                console.warn('Элемент canvas для графика прогресса не найден');
                return;
            }

            console.log('Создание графика прогресса на основе данных:', state.progressData);

            // Группируем прогресс по частотам
            const frequencyGroups = {};

            state.progressData.forEach(progress => {
                if (!progress.frequency) {
                    console.warn('Обнаружена запись без указания частоты:', progress);
                    return; // Пропускаем записи без частоты
                }

                if (!frequencyGroups[progress.frequency]) {
                    frequencyGroups[progress.frequency] = {
                        totalUsers: 0,
                        completed: 0,
                        inProgress: 0
                    };
                }

                frequencyGroups[progress.frequency].totalUsers++;

                if (progress.completed) {
                    frequencyGroups[progress.frequency].completed++;
                } else {
                    frequencyGroups[progress.frequency].inProgress++;
                }
            });

            // Проверяем, есть ли данные после группировки
            if (Object.keys(frequencyGroups).length === 0) {
                console.warn('После группировки не осталось данных для графика');
                chartCanvas.innerHTML = '<div class="no-data">Недостаточно данных для отображения';
                return;
            }

            console.log('Сгруппированные данные для графика:', frequencyGroups);

            // Подготавливаем данные для графика
            const labels = Object.keys(frequencyGroups);
            const completedData = labels.map(freq => frequencyGroups[freq].completed);
            const inProgressData = labels.map(freq => frequencyGroups[freq].inProgress);

            // Если уже есть график, уничтожаем его перед созданием нового
            if (state.charts.progressChart) {
                state.charts.progressChart.destroy();
            }

            // Создаем новый график
            const ctx = chartCanvas.getContext('2d');

            state.charts.progressChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                            label: 'Завершено',
                            data: completedData,
                            backgroundColor: 'rgba(3, 251, 141, 0.7)',
                            borderColor: 'rgba(3, 251, 141, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'В процессе',
                            data: inProgressData,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Частота',
                                color: '#03FB8D'
                            },
                            ticks: {
                                color: '#03FB8D'
                            },
                            grid: {
                                color: 'rgba(3, 251, 141, 0.1)'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Количество пользователей',
                                color: '#03FB8D'
                            },
                            ticks: {
                                color: '#03FB8D',
                                beginAtZero: true,
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(3, 251, 141, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#03FB8D'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Прогресс пользователей по частотам',
                            color: '#03FB8D'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw;
                                    return `${label}: ${value} пользователей`;
                                }
                            }
                        }
                    }
                }
            });

            console.log('График прогресса успешно создан');
        }

        /**
         * Обёртка над fetch с обработкой ошибок и логированием
         * @param {string} url - URL запроса
         * @param {object} options - опции fetch
         * @returns {Promise<any>} - ответ в формате JSON
         */
        async function safeFetch(url, options = {}) {
            console.log(`Выполняется запрос к: ${url}`, options);

            try {
                // Устанавливаем заголовки по умолчанию, если они не указаны
                if (!options.headers) {
                    options.headers = {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    };
                }

                // Добавляем credentials, если не указаны
                if (!options.credentials) {
                    options.credentials = 'include';
                }

                // Выполняем запрос
                const response = await fetch(url, options);

                // Проверяем статус ответа
                if (!response.ok) {
                    // Пытаемся получить текст ошибки
                    let errorText = '';
                    try {
                        errorText = await response.text();
                    } catch (e) {
                        errorText = 'Не удалось получить текст ошибки';
                    }

                    console.error(`Ошибка запроса к ${url}: ${response.status} ${response.statusText}`, errorText);
                    throw new Error(`Ошибка сервера: ${response.status} ${response.statusText}`);
                }

                // Парсим JSON-ответ
                const data = await response.json();
                console.log(`Успешный ответ от ${url}:`, data);
                return data;
            } catch (error) {
                console.error(`Ошибка при выполнении запроса к ${url}:`, error);
                throw error;
            }
        }

        // Отрисовка данных о прогрессе пользователей
        function renderProgressData() {
            const tableBody = document.getElementById('progress-table-body');

            if (!tableBody) return;

            tableBody.innerHTML = '';

            // Проверка на наличие данных
            if (!state.progressData || state.progressData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Нет данных о прогрессе пользователей';

                // Очищаем график
                const chartCanvas = document.getElementById('progress-chart');
                if (chartCanvas) {
                    if (state.charts.progressChart) {
                        state.charts.progressChart.destroy();
                        state.charts.progressChart = null;
                    }
                    const ctx = chartCanvas.getContext('2d');
                    if (ctx) {
                        ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                    }
                    chartCanvas.innerHTML = '<div class="no-data">Нет данных для отображения';
                }

                return;
            }

            console.log(`Отрисовка данных о прогрессе: ${state.progressData.length} записей`);

            // Сортируем по пользователю и частоте
            const sortedProgress = [...state.progressData].sort((a, b) => {
                if (a.username !== b.username) {
                    return a.username.localeCompare(b.username);
                }
                return a.frequency.localeCompare(b.frequency);
            });

            // Отрисовка таблицы
            sortedProgress.forEach(progress => {
                const row = document.createElement('tr');

                // Получаем значение прогресса
                // Если progress.progress - это строка (например, "50 из 100"), преобразуем её в число
                // Получаем значение прогресса
                let progressPercent = 0;

                if (typeof progress.progress === 'number') {
                    // Если это число от 0 до 100, используем как есть
                    progressPercent = progress.progress;
                } else if (typeof progress.progress === 'string') {
                    // Если это строка, пытаемся преобразовать в число
                    // Например, "50 из 100" -> 50
                    const match = progress.progress.match(/(\d+)/);
                    if (match && match[1]) {
                        progressPercent = parseInt(match[1]);
                    }

                    // Если строка содержит процент или часть, рассчитываем соотношение
                    if (progress.progress.includes('/') || progress.progress.includes(' из ')) {
                        const parts = progress.progress.split(/[ \/]/);
                        const current = parseInt(parts[0]);
                        const total = parseInt(parts[parts.length - 1]);
                        if (!isNaN(current) && !isNaN(total) && total > 0) {
                            progressPercent = Math.round((current / total) * 100);
                        }
                    }
                }

                // Убедимся, что значение в допустимом диапазоне
                progressPercent = Math.max(0, Math.min(100, progressPercent));

                console.log(`Прогресс для ${progress.username} (${progress.frequency}): ${progress.progress} -> ${progressPercent}%`);

                row.innerHTML = `
         <td>${progress.username}
         <td>${progress.frequency}
         <td>
         <div style="width: 100%; background: rgba(3, 251, 141, 0.1); height: 10px;">
         <div style="width: ${progressPercent}%; background: #03FB8D; height: 100%;">
         
         <div style="text-align: center; margin-top: 5px;">${progressPercent}% (${progress.progress || '0'})
         
         <td>${progress.completed ? 'Да' : 'Нет'}
         `;

                tableBody.appendChild(row);
            });

            // Создаем диаграмму прогресса
            try {
                createProgressChart();
            } catch (error) {
                console.error('Ошибка при создании графика прогресса:', error);

                const chartCanvas = document.getElementById('progress-chart');
                if (chartCanvas) {
                    chartCanvas.innerHTML = '<div class="no-data">Ошибка при создании графика';
                }
            }

            if (document.getElementById('progress-content')) {
                document.getElementById('progress-content').style.display = 'block';
            }
        }

        // Выход из системы
        async function logout() {
            try {
                await fetch(`${API_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                // Перенаправляем на страницу входа
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Ошибка при выходе из системы:', error);
                alert('Произошла ошибка при выходе из системы. Пожалуйста, попробуйте еще раз.');
            }
        }

        // Вспомогательные функции

        // Показать индикатор загрузки
        function showLoading(tabId) {
            const loadingElement = document.getElementById(`${tabId}-loading`);
            const contentElement = document.getElementById(`${tabId}-content`);

            if (loadingElement) {
                loadingElement.style.display = 'flex';
            }

            if (contentElement) {
                contentElement.style.display = 'none';
            }
        }

        // Скрыть индикатор загрузки
        function hideLoading(tabId) {
            const loadingElement = document.getElementById(`${tabId}-loading`);
            const contentElement = document.getElementById(`${tabId}-content`);

            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            if (contentElement) {
                contentElement.style.display = 'block';
            }
        }

        // Показать сообщение об ошибке
        function showErrorMessage(elementId, message) {
            const element = document.getElementById(elementId);

            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = message;

            element.innerHTML = '';
            element.appendChild(errorDiv);
            element.style.display = 'block';

            // Автоматически скрываем сообщение через 5 секунд
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Показать сообщение об успехе
        function showSuccessMessage(elementId, message) {
            const element = document.getElementById(elementId);

            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.textContent = message;

            // Вставляем перед элементом
            element.parentNode.insertBefore(successDiv, element);

            // Автоматически скрываем сообщение через 5 секунд
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // Генерация фонового "кода" для киберпанк-стиля
        function generateBackgroundCode() {
            const bgElement = document.getElementById('bgCode');

            // Генерируем строки "кода"
            const codeStrings = [
                "function initGMS4521() { return { status: 'ACTIVE', secLevel: 'ALPHA-7' }; }",
                "const terminalAccess = new SecurityProtocol('ADMIN', 0x7F);",
                "if (securityBreached) { initCountermeasures(PROTOCOL.OMEGA); }",
                "class DataStream extends BinaryProtocol { constructor() { super(0x8F); } }",
                "await terminal.connect('/dev/tty0', { encrypted: true });",
                "for (let i = 0; i < dataNodes.length; i++) { validate(dataNodes[i]); }",
                "const encryptionLevel = LEVEL.MAXIMUM; // Required for GMS access",
                "function parseIncomingSignals(data) { return new Transmission(data); }",
                "encryption.applyKey(generateRandomBytes(32));",
                "while (terminal.active) { terminal.processCommands(); }",
                "const vulnerabilities = system.scanForThreats();",
                "if (userAccess.level < 7) { throw new SecurityException(); }",
                "terminal.display('АКТИВИРОВАН ПРОТОКОЛ БЕЗОПАСНОСТИ GMS-4521');",
                "for (const node of network.activeNodes) { ping(node.address); }",
                "const userAccessLevel = authentication.validateCredentials(user);",
                "async function establishSecureConnection() { /* ... */ }",
                "if (signal.strength < MIN_THRESHOLD) { boost(signal); }",
                "mainframe.execute(COMMAND.SYSTEM_SCAN, { priority: HIGH });",
                "try { connectToSatellite(); } catch (e) { useBackupLink(); }",
                "const encryptedMessage = encode(message, KEY.SECRET);",
                "dataTransmission.start({ protocol: 'QUANTUM', packetSize: 1024 });",
                "function detectIntrusion(logs) { return logs.filter(isAnomaly); }",
                "const securityStatus = terminal.checkPerimeterSystems();",
                "const dataChannels = network.getSecureChannels().filter(isActive);",
                "if (DEFCON_LEVEL === 1) { initEmergencyProtocols(); }"
            ];

            // Добавляем строки "кода" на страницу с разным расположением
            for (let i = 0; i < 50; i++) {
                const codeLine = document.createElement('div');
                codeLine.className = 'code-line';

                // Случайная строка из набора
                codeLine.textContent = codeStrings[Math.floor(Math.random() * codeStrings.length)];

                // Случайное расположение
                codeLine.style.left = `${Math.random() * 100}%`;

                // Случайная скорость анимации (от 10 до 30 секунд)
                const duration = 10 + Math.random() * 20;
                codeLine.style.animationDuration = `${duration}s`;

                // Случайная задержка начала анимации
                codeLine.style.animationDelay = `${Math.random() * 10}s`;

                bgElement.appendChild(codeLine);
            }
        }
    </script>
</body>

</html>