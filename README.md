# Диалоговая система (Рефакторинг)

Данный проект представляет собой html-интерфейс + Node.js сервер для управления диалогами и базой данных пользователей.

Так как это капец какая сырая хренотень (но рабочая), возможно внутри кода вы найдете повесившихся кодеров, которые читали этот пи***ц и не выдержали ужаса. (Ах да, код помогает мне в основном корректировать ИИ).

## Для чего это нужно?
- У меня есть НРИ игры по Sci-Fi тематике, так как я не могу регулярно придумывать кампании, чтобы немного занять игроков и познакомить их с будущими НПЦ или поговорить с знакомыми была создана эта система.
- Возможность просто послушать диалог при 1х или более лицах (тусуя их между собой в конфиге)
- Возможность выбирать в диалоге ответ, влияющий на строчки диалога (ну и само собой это придет к созданию очень ветвистой структуры диалогов)

- Вы так же можете зайти в админ панель, которая показывает, какой пользователь и что выбрал, чтобы на основе выбора строить диалоги дальше. (лучше не вчитывайтесь в admin.html мой вам совет)
Получить админку можно, если прописать в БД в таблице пользователей параметр is_admin на 1

В системе предусмотрена система регистрации для входа на страницы, а так же страница администратора

## Установка

### Требования
- Node.js v16+ (рекомендуется v18+)
- npm

### Установка зависимостей
```bash
npm install
```

### Конфигурация
Создайте файл `.env` в корне проекта с настройками:

```env
# Server Configuration
PORT=3000
DB_PATH=./database.db
SSL_DIR=./server side/ssl

# Security
SESSION_SECRET=your_secure_session_secret_here
NODE_ENV=development

# CORS
ALLOWED_ORIGINS=https://localhost,https://127.0.0.1
```

### Запуск
1. Содержимое client side скопируйте на сайт в удобное для вас место.
2. Откройте login-api.js/admin.html/dialogue.js и замените URL-адреса на ваш сайт с вашим портом
3. Содержимое server side скопируйте куда угодно на хостируемой машине
4. Установите зависимости: `npm install`
5. Запустите сервер: `node server.js`

### SSL сертификаты
Для работы HTTPS сервера положите файлы сертификата в папку `server side/ssl`:
- `cert.pem` - публичный сертификат
- `privkey.pem` - приватный ключ

## API endpoints

### Пользователи
- `POST /api/register` - регистрация
- `POST /api/login` - вход
- `GET /api/check-auth` - проверка авторизации
- `POST /api/logout` - выход

### Диалоги
- `GET /api/dialogue-progress` - получить прогресс диалогов
- `POST /api/dialogue-progress` - сохранить прогресс диалога
- `POST /api/user-choice` - сохранить выбор пользователя
- `GET /api/user-choices/:frequency` - получить выборы пользователя

### Админка
- `GET /api/admin/users` - получить всех пользователей
- `POST /api/admin/change-password` - изменить пароль пользователя
- `GET /api/admin/choice-statistics` - получить статистику выборов
- `GET /api/admin/choice-details/:frequency/:choiceId` - получить детали выбора
- `GET /api/admin/user-progress` - получить прогресс пользователей
- `GET /api/admin/check` - проверить права администратора

## Безопасность
- Все пароли хешируются с использованием bcrypt
- Сессии защищены с помощью httpOnly и secure cookies
- Валидация всех входных данных
- CSRF защита через sameSite cookies

## Настройка администратора
Чтобы получить права администратора:
1. Зарегистрируйте первого пользователя
2. Вручную установите `is_admin = 1` в таблице users в БД для нужного пользователя

## Файловая структура
```
/workspace/
├── client side/           # Frontend файлы
│   ├── assets/            # Изображения, звуки и т.д.
│   ├── scripts/           # JS скрипты
│   ├── styles/            # CSS стили
│   ├── Config.js          # Конфигурация диалогов
│   ├── index.html         # Основная страница
│   ├── login.html         # Страница входа
│   └── splash.html        # Стартовая страница
├── server side/           # Backend файлы
│   ├── server.js          # Основной сервер
│   ├── ssl/               # SSL сертификаты
│   └── database.db        # База данных SQLite
├── .env                   # Конфигурация окружения
└── package.json           # Зависимости
```

## Известные проблемы
- Некоторые функции админки могут быть нестабильны при большом объеме данных
- Не все ошибки обрабатываются корректно

Я не гарантирую, что оно у вас заведется, да и вообще на себя какие то обязательства брать не хочу, просто высираю свой какич в надежде на то, что кому то оно пригодится.
